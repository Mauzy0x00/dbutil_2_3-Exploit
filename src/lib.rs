use std::ffi::c_void;
use windows_sys::Win32::System::IO::*;
use windows_sys::Win32::Storage::FileSystem::*;
// use windows_sys::Win32::System::Diagnostics::Debug::*;
use windows_sys::Win32::Foundation::*;

// Open a handle to the DBUtil driver using its symbolic link name
pub unsafe fn open_dev() -> HANDLE {
    CreateFileA(
        "\\\\.\\DBUtil_2_3\0".as_ptr() as _,        // '\\\\.\\' prefix is the modern way to to say "DosDevices" which represents the global namespace. The function is expecting null termination so '\0' is appended
        GENERIC_READ | GENERIC_WRITE,          // These are access permissions. These require the windows-sys crate, not the standard windows crate in rust
        FILE_SHARE_READ | FILE_SHARE_WRITE,
        std::ptr::null_mut(),
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL,
        std::ptr::null_mut(),
    )
}

// Take a handle to the DBUtil device
pub unsafe fn ioctl(dev: HANDLE, num: u32, io_buffer: *mut c_void, buffer_length: usize) -> bool {
    DeviceIoControl(
        dev,        
        num,                    // IOCTL code
        io_buffer,                   // IO buffer
        buffer_length as _,       // IO buffer size
        io_buffer,                  // IO buffer
        buffer_length as _,      // UI buffer size
        std::ptr::null_mut(),   // null_mut
        std::ptr::null_mut(),      // null_mut
    ) != 0
}

pub fn add(left: usize, right: usize) -> usize {
    left + right
}

#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn it_works() {
        let result = add(2, 2);
        assert_eq!(result, 4);
    }
}
